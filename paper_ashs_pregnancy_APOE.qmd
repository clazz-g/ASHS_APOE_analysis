---
title: "Parity and AD specific neurodegeneration"
author: "Clazz"
toc: true
number-sections: true
format: 
  html:
    code-fold: true
  docx: default 
editor: visual
bibliography: references.bib
csl: elsevier-vancouver.csl
---

```{r, include = F}

if (!require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse, VIM, ggpubr, ggeffects, car, sjPlot,caret, ggrain, emmeans, skimr, lavaan, patchwork, lme4, lmerTest, gtsummary, huxtable, readxl, broom.mixed, pwrss)
```



```{r setup, include=FALSE}

# Project: ASHS_APOE_analysis
# Script: paper_ashs_pregnancy_APOE.R
# Author: Clazz
# Date: 25/09/2025
#
# DATA SOURCES:
# - ALFA+: G:/My Drive/Data/ALFA+
#
#


# Register an inline hook:
options(scipen = 1, digits = 3)

knitr::opts_chunk$set(
  fig.width = 8,
  fig.height = 8,
  out.width = "100%",
  dpi = 300
)

config <- config::get()

source("C:/Users/U253662/Documents/git/functions/jt_plot_aesthetics.R")
```

# Abstract

300 words

# Introduction

Alzheimer's disease (AD) is a neurodegenerative disorder clinically characteized by progressive memory loss. Ageing, carring the apolipoprotein E E4 (APOE4) and having female chromosomal sex are three established risk factors for the typical late-onset of this disease @riedel2016. Carrying one copy of APOE4 increases AD risk by three to four fold, whilst carrying 2 copies skyrockets that risk to 10 folds @corder1993. Women have a higher incidence of late-onset AD dementia @beam2018 and show faster cognitive decline after diagnosis of MCI or AD dementia @sexdiff2018. Amongst APOE4 carriers, women exhibit an increased risk of conversion from healthy ageing to MCI, or from MCI to AD dementia between the ages of 65 to 75 [@Altmann2014; @Neu2017]. Thus to understand sex differences in AD risk it is essential to understand how these non-modifyable risk factors interact.

The hippocampus is one of the first regions affected by AD, and whole hippocampal volume is a hallmark predictor of conversion from MCI to AD @apostolova2006. one of its particularity resides in its display of continuous neurogenesis throughout adult life @boldrini2018. ?? The hippocampus is not a homogenous structure, but is divided in anatomical subfields that show different molecular makeup () and a degree of cognitive specialization @mueller2011. Altered neurogenesis is linked to AD related neuropathology and impairments in cognition @hollands2017.

Pregnancy provokes significant changes to brain structure via major hormonal changes which impact the hippocampus in a lasting way @puri2023. Animal models show decreased neurogenesis in the hippocampus during gestation and postpartum period [@pawluski2007; @eid2019]. In humans, pregnancy is associated with a total hippocampal volume loss which then recovers in the next two years post partum @Hoekzema2017. Currently, there is a lack of data on how these mid-life changes affect the hippocampus in older adults, and wether they have consequences on cognition.

Evidence on how previous pregnancies influence ageing and AD risk is conflicting. Previous parity has been linked with less apparent brain ageing @de2020. But amongst epidemiological studies that explored a potential association between parity and AD, some report a link between multiparity and greater cognitive decline @colucci2006, whilst other report no link or the opposite findings [@Fox2018; @Fox2013.; @wolfova2024] To our knowledge, only two studies so far have included AD biomarkers as a dependent variable, and whilst one repports a positive relationship between amyloid plaques and parity, the other does not[@Beeri2009a; @Jung2020]. Together, these studies indicate that although a link might exist between parity and AD, it is not well characterized and shows mixed direction of effect.

Recently, Bee and colleagues (2024) @lee2024 presented the first evidence for an interaction between APOE4 and parity in animals. Using wildtype and humanized APOE4 knock-in middle aged female rats, they found that whilst parity increased neurogenesis in wildtype rats, it decreased it in APOE4 rats, especially in the ventral dentate gyrus. In addition to this, parous APOE4 rats showed increased use of allocentric strategy instead of spatial when solving spatial memory tasks, suggesting a decreased recruitment of the hippocampus. Importantly, this aligns with previous literature reporting a link between AD dementia and decreased use of spatial strategy in humans @parizkova2018. To our knowledge, no study has explored this interaction of APOE4 and parity on hippocampal structure in humans.

Our objective was to explore potential links and mechanisms through which pregnancy interacts with AD pathology in healthy postmenopausal women at risk of AD. To this end, we used hippocampal volumetry drawn from MRI data, biomarker data, cogntive data and reproductive data from two initial visits from the ALFA+cohort. We hypothesized that parous women would show decreased whole hippocampal volume loss but this relationship would be inversed in APOE4 carriers.

# Methods

## Study population

This observational cohort study includes postmenopausal women from the ongoing ALFA+ study (Clinicaltrials.gov, NCT01835717) who completed at least the baseline visit. The second visit was included as well when data was available (average time between visits of 3.32 years). ALFA+ is a research cohort of middle-aged cognitively unimpaired participants, many of whom are offspring of AD patients, based in Barcelona, Spain. Participants undergo an extensive battery of tests, questionnaires and measurements every 3 years with the main aim of identifying the earliest pathophysiological changes in the preclinical AD continuum. The study was approved by the Independent Ethics Committee “Parc de Salut Mar”, Barcelona, and all participants gave written informed consent. Baseline visits took place between 2016 and 2019 and the follow-up visit between 2019 and 2022.

In brief, inclusion criteria were: 1) participants who had previously participated in the 45-65/FPM2012 study (ALFA parent cohort); 2) age between 45 and 75 years at the moment of the inclusion in the cohort; 3) long-term commitment to to undergo all tests and study procedures (MRI, PET, and lumbar puncture). Exclusion criteria included: 1) cognitive impairment (Clinical Dementia Rating \[CDR\] \> 0, Mini-Mental State Examination \[MMSE\] \< 27, semantic fluency \< 12); 2) any significant systemic illness or unstable medical condition which could lead to difficulty complying with the protocol; 3) any contraindication to any test or procedure; 4) family history of monogenic AD. In addition, women with a history of cardiovascular-related gestational disease, such as preeclampsia, were excluded from our sample for analysis.

## Reproductive variables

Parity was defined as the number of biological children and used as a continuous variable in our main analyses. This information was self-reported by individuals during an interview with a clinician at baseline visit.

## Cognitive measures

Preclinical Alzheimer's cognitive composite (PACC) was computed including the Total Paired Recall (TPR) and Total Delayed Free Recall scores of the Memory Binding Test @buschke2017, the Coding subtest of the Wechsler Adult Intelligence Scale-Fourth Edition (WAIS-IV), and semantic fluency, as defined in previous works @mormino2017. Z-scores were computed for Visit 1 and 2.

## AD biomarkers

CSF collection, processing, and storage in the ALFA+ study have been described previously @Milà-Alomà2020. CSF A42 and A40 were measured with the exploratory Roche NeuroToolKit immunoassays (Roche Diagnostics International Ltd, Rotkreuz, Switzerland) on a cobas e 601 module. Measurements were performed at the Clinical Neurochemistry Laboratory, Sahlgrenska University Hospital, Molndal, Sweden. Aß status (Aß+, Aß–) was defined using the cutoff of 0.071 for the ratio Aß42/40 @Milà-Alomà2020, where any participant below this cutoff was considered to be Aß+.

## Imaging data acquisition and preprocessing

Automatic Segmentation of Hippocampal Subfields (ASHS) software @Yushkevich2015 was used on the T1, T2 and inversion recovery (IR) images to segment the hippocampal formation in the following sub-regions: Brodmann areas 35 and 36, cornu Ammonis (CA) 1, 2 and 3, dentate gyrus (DG), entorhinal cortex (ERC), parahippocampus (PHC), subiculum (SUB), and sulcus (SUL). All segmentations were visually inspected before proceeding with the statistical analyses. 

Hippocampal values are reported in mm3. Values were collected at baseline and follow-up visit. 

## Covariates

HV analyses were adjusted by total intracranial volume, CSF Aß (dichotomous or continuous?), years of education (continuous) and age at baseline visit (continuous). Cognitive analyses were adjusted for *CSF* Aß, years of education and age at baseline visit. All analyse estimates, standard errors and p values are reported adjusted for these covariates.

-   I lean toward continous CSF ratio because we lose the least amount of info

## Statistical analyses

Analyses were conducted using R version 4.5.1. 

Normality of residuals was checked in all linear models using the base R plot() function on model output. Collinearity was also checked for all models using the vif() function of the car package (v.3.1.3).

We conducted simple linear regressions to examine cross-sectional associations between parity and Aβ positivity (exposures) on hippocampal volume and PACC score (outcomes) using baseline visit data. Following this, mixed-effects linear models were used to assess longitudinal effects of parity and Aβ positivity (exposures) on hippocampal volume and cognitive change (outcomes) using baseline and follow-up visit data. These models included a three-way interaction term between parity, Aβ positivity, and time (interval between Visit 1 and Visit 2).

All models used a p-value threshold of p \< 0.05. 

Data imputation methods were implemented using the mice package in R (v.3.18.0) on covariates, but not exposure or outcome variables. For continuous variables, predictive mean matching with 5 donors was used. For categorical variables, logistic regression was used.

## Sensitivity analyses

Analyses that showed a significant effect of parity on the outcome were reproduced using parity as a categorical variable to examine potential non-linear effects. The variable was defined as follows: nulliparous (0 childbirth), primiparous (1 childbirth) and multiparous (2+ childbirths). Because these analyses were underpowered for this group interaction, we also provide group comparison using estimated marginal means to examine specific parity group differences depending on Aβ load.

Additional linear regressions were also performed to explore the interaction between parity and Aβ positivity on individual hippocampal subfield volumes using baseline data. These analyses can be found in the supplemental materials. Given the exploratory nature of these analyses, results are reported without correction for multiple comparisons.

# Results

```{r, include=FALSE}
# creating basic dataset

data_naked<-read_delim(paste0(config$alfa_dataset_cleaned, "ALFA_dataset_basic.csv"), 
    delim = ",", escape_double = FALSE, trim_ws = TRUE)%>%
  mutate(sex=factor(sex),
         APOE_binary = factor(APOE_binary), 
         subject=as.numeric(subject),
         parous_group= factor(parous_group))

alfa_subjects<-data_naked%>%
  dplyr::select(subject, sex)

#adding scan dates for descriptives, horizontal 
date_mri_v1<-read_excel(paste0(config$alfa_dataset_neuroimaging, "scan_dates/bx_scandates_ALFA_PLUS_V1_20231120_20250210_135308.xlsx"))%>%
  dplyr::select(subject_label, scandate)%>%
  mutate(subject_label = as.numeric(subject_label))%>%
  rename(subject = subject_label,
         scandate_v1 = scandate)

date_mri_v2<-read_excel(paste0(config$alfa_dataset_neuroimaging, "scan_dates/bx_scandates_ALFA_PLUS_V2_20230518_20250210_135351.xlsx"))%>%
  dplyr::select(subject_label, scandate)%>%
  mutate(subject_label = as.numeric(subject_label))%>%
  rename(subject = subject_label,
         scandate_v2 = scandate)

date_mri_long<-full_join(date_mri_v1, date_mri_v2)%>%
  mutate(scandate_v1 = as.Date(scandate_v1, format = "%Y-%m-%d"),
         scandate_v2 = as.Date(scandate_v2, format = "%Y-%m-%d"),
         diff_mri = as.numeric(difftime(scandate_v2, scandate_v1, units = c("days")))/365.25)

data_biomarkers<-read_delim(paste0(config$alfa_dataset_cleaned, "biomarkers_CSF_processed.csv"), 
    delim = ",", escape_double = FALSE, trim_ws = TRUE)%>%
  filter(Visit == "V1")%>%
  dplyr::select(-Visit)%>%
  mutate(A=factor(A))

#adding MRI sessions dates to the dataset
data<-left_join(data_naked, date_mri_long)%>%
  mutate(DOB = as.Date (DOB, format = "%Y-%m-%d"),
         age_v1_mri = as.numeric(difftime(scandate_v1, DOB, units= c("days")))/365.25,
         age_v2_mri = as.numeric(difftime(scandate_v2, DOB, units= c("days")))/365.25)%>%
  left_join(., data_biomarkers)


```

```{r hippocampus_data, include = F}
ashs1<-read_excel(paste0(config$alfa_dataset_neuroimaging, "ASHS/bx_ashs_volumes_ALFA_PLUS_V1_20231120_20250702_164509.xlsx"))%>%
  dplyr::select(subject, region, side, volume)%>%
  group_by(subject, region) %>%
  summarize(volume = sum(volume), .groups = "drop")%>%
  pivot_wider(names_from = region, values_from = volume, names_prefix = "vol_")%>%
  mutate(Visit = 1,
         subject= as.numeric(subject))

ashs1b<-read_excel(paste0(config$alfa_dataset_neuroimaging, "ASHS/bx_ashs_volumes_ALFA_PLUS_EXP_20250918_161906.xlsx"))%>%
  dplyr::select(subject, region, side, volume)%>%
  group_by(subject, region) %>%
  summarize(volume = sum(volume), .groups = "drop")%>%
  pivot_wider(names_from = region, values_from = volume, names_prefix = "vol_")%>%
  mutate(Visit = 1,
         subject= as.numeric(subject))%>%
  filter(subject != 11331,
         subject != 10634,
         subject!= 13368)
  

ashs2<-read_excel(paste0(config$alfa_dataset_neuroimaging, "ASHS/bx_ashs_volumes_ALFA_PLUS_V2_20230518_20250702_165801.xlsx"))%>%
  dplyr::select(subject, region, side, volume)%>%
  group_by(subject, region) %>%
  summarize(volume = sum(volume), .groups = "drop")%>%
  pivot_wider(names_from = region, values_from = volume, names_prefix = "vol_")%>%
  mutate(Visit = 2,
         subject= as.numeric(subject))

data_ashs<-ashs1%>%
  bind_rows(ashs1b)%>%
  bind_rows(ashs2)%>%
  mutate(subject = as.numeric(subject),
         vol_HIPP = vol_CA1+vol_CA2+vol_CA3+vol_DG+vol_SUB)%>%
  right_join(., data)%>%
  mutate(diff_mri = ifelse(Visit==1, 0, diff_mri))
 
```

```{r cognition_data, include=F}
cognition<-read_excel(paste0(config$alfa_dataset_cognition, "PACCv1_to_v3(incomplete).xlsx"))%>%
  dplyr::select(IdParticipante, Visit, Z_PACC, Z_FCSRTI_RT, Z_aWMS_DR_RS, Z_Wclave_totalscr, Z_FS_totalcnswr, FechaResultado)%>%
  rename(subject = IdParticipante)

time_diff<-read_excel(paste0(config$alfa_dataset_cognition, "PACCv1_to_v3(incomplete).xlsx"))%>%
  dplyr::select(IdParticipante, Visit,FechaResultado)%>%
  rename(subject = IdParticipante)%>%
  filter(Visit != 3)%>%
  pivot_wider(names_from = Visit, values_from = FechaResultado, names_prefix = c("Fecha_Resultado"))%>%
  mutate(time_diff = as.numeric(difftime(Fecha_Resultado2, Fecha_Resultado1, units= c("days"))))%>%
  dplyr::select(subject, time_diff)

data_cog_long<- left_join(data, cognition)%>%
  mutate(age_cog = as.numeric(difftime(FechaResultado, DOB, units= c("days")))/365.25)%>%
  group_by(subject)%>%
  filter(Visit != 3) %>%
  filter(n()>=2)%>%
  relocate(Visit, .after=sex)%>%
  ungroup()%>%
  left_join(., time_diff)%>%
  mutate(time_diff = ifelse(Visit == 1, 0, time_diff))
```

```{r intext_descriptives, include=F}

participants_v1_cog<-read_excel(paste0(config$alfa_dataset_cognition, "PACCv1_to_v3(incomplete).xlsx"))%>%
  dplyr::select(IdParticipante, Visit, Z_PACC)%>%
  rename(subject = IdParticipante)%>%
  filter(Visit == 1)%>%
   right_join(., alfa_subjects)%>%
  filter(sex==2)%>%
  drop_na(Z_PACC)%>%
  nrow()

participants_v2_cog<-read_excel(paste0(config$alfa_dataset_cognition, "PACCv1_to_v3(incomplete).xlsx"))%>%
  dplyr::select(IdParticipante, Visit, Z_PACC)%>%
  rename(subject = IdParticipante)%>%
  filter(Visit == 2)%>%
   right_join(., alfa_subjects)%>%
  filter(sex==2)%>%
  drop_na(Z_PACC)%>%
  nrow()
  
participants_v1_mri<-data%>%
  drop_na(scandate_v1)%>%
  filter(sex==2)%>%
  nrow

participants_v2_mri<-data%>%
  drop_na(scandate_v2)%>%
    filter(sex==2)%>%
  nrow


```

## Descriptive results

```{r, include = F}
alfa_participants_v1<-read_delim(paste0(config$alfa_dataset_raw, "Alfa Plus Long 2025__AlfaPlus_general_20250304095809(in).csv"), delim= ";", col_names = TRUE)%>%
  rename(subject = IdParticipante)%>%
  right_join(., alfa_subjects)%>%
  filter(sex==2)%>%
  dplyr::select(subject,Age_V1)%>%
  drop_na()%>%
  nrow()

alfa_participants_v2<-read_delim(paste0(config$alfa_dataset_raw, "Alfa Plus Long 2025__AlfaPlus_general_20250304095809(in).csv"), delim= ";", col_names = TRUE)%>%
  rename(subject = IdParticipante)%>%
  right_join(., alfa_subjects)%>%
  filter(sex==2)%>%
  dplyr::select(subject,Age_V2)%>%
  drop_na()%>%
  nrow()

alfa_subjects_dropout<-read_delim(paste0(config$alfa_dataset_raw, "Alfa Plus Long 2025__AlfaPlus_general_20250304095809(in).csv"), delim= ";", col_names = TRUE)%>%
rename(subject = IdParticipante)%>%
  right_join(., alfa_subjects)%>%
  filter(sex==2)%>%
  filter(is.na(Age_V2))%>%
  dplyr::select(subject)

dropout<-read_delim(paste0(config$alfa_dataset_raw, "Alfa Plus Long 2025_2010_STF_20250304095809(in).csv"), delim= ";", skip=1, col_names = TRUE, locale = locale(encoding = "Latin1") )%>%
  rename(subject = IdParticipante)%>%
  right_join(., alfa_subjects_dropout, join_by(subject))%>%
  dplyr::select(subject, STF_state, STF_reas, STF_reas5, STF_EspeIncumCri)%>%
  mutate(STF_reas = factor(STF_reas, levels = c("1", "2", "3", "4", "5", "6", "7"), labels = c("Death", "No response", "Participant withdrawal", "Clinician decision", "Promotor decision", "Protocol issue", "Other")),
         STF_state = factor(STF_state, levels = c("1", "2", "3", "4"), labels = c("Completed", "Failed preescreening", "Failed screening", "Discontinued")))

cognition1<-cognition%>%
  filter(Visit==1)%>%
  dplyr::select(subject, Z_PACC)

cognition2<-cognition%>%
  filter(Visit==2)%>%
  dplyr::select(subject, Z_PACC)

data_table<-data%>%
  filter(sex==2)%>%
  left_join(., ashs1)%>%
  mutate(vol_HIPP_v1 = vol_CA1+vol_CA2+vol_CA3+vol_DG+vol_SUB)%>%
  left_join(., cognition1)%>%
  rename(Z_PACC_v1 = Z_PACC)%>%
  dplyr::select(age_v1, kids_total, A, APOE_binary, education, vol_tiv, vol_HIPP_v1, Z_PACC_v1, subject)%>%
  mutate(A=ifelse(A==1, "Aβ+", "Aβ-"),
         APOE_binary=ifelse(APOE_binary==1, "Carrier", "Non-Carrier"),
         kids_total= ifelse(kids_total==4, "4+", as.character(kids_total)))%>%
  left_join(., ashs2, join_by(subject))%>%
  mutate(vol_HIPP_v2 = vol_CA1+vol_CA2+vol_CA3+vol_DG+vol_SUB)%>%
 dplyr::select(age_v1, kids_total, A, APOE_binary, education, vol_tiv.x, vol_HIPP_v1, vol_HIPP_v2, Z_PACC_v1, subject)%>%
  left_join(.,cognition2)%>%
  rename(Z_PACC_v2 = Z_PACC)%>%
   dplyr::select(age_v1, kids_total, A, APOE_binary, education, vol_tiv.x, vol_HIPP_v1, vol_HIPP_v2, Z_PACC_v1, Z_PACC_v2)
 

desc_table<-tbl_summary(data_table,
            by = kids_total, 
            missing = "no",
            label= list(kids_total = "Number of childbirths",
                     A= "Aβ status, Count (%)",
                     APOE_binary = "APOE-E4 carrier, Count (%)",
                     age_v1 = "Age at first visit, Mean (SD)",
                     vol_tiv.x = "Baseline Total Intracranial Volume (cm3), Mean (SD)",
                     education = "Education (years), Mean (SD)",
                     vol_HIPP_v1 = "Baseline Hippocampal volume, Mean (SD)",
                     vol_HIPP_v2 = "Follow-up Hippocampal volume, Mean (SD)",
                     Z_PACC_v1 = "Baseline PACC z-score, Mean (SD)",
                     Z_PACC_v2 = "Follow-up PACC z-score, Mean (SD)"))%>%
  add_n()%>%
  add_p()%>%
  modify_header(label = "**Variables**") %>% # update the column header
  bold_labels()


```

```{r, echo = F, warning=F}
desc_table
```

`r alfa_participants_v1` female participants from the ALFA+ project were included in our analyses at Visit 1, and `r alfa_participants_v2` at visit 2. Out of the 43 participants who dropped out of the study between both visits, 30 oficially withdrew for personal reasons, 3 became unresponsive, 2 died, 5 showed accidental findings on their structural MRI and 3 showed altered cognitive states. Visit 1 included MRI data from `r participants_v1_mri` participants and cognitive testing from `r participants_v1_cog` participants. Visit 2 included MRI data from `r participants_v2_mri` participants and cognitive testing from `r participants_v2_cog` participants. Average time between visits was 3.32 years.

15.35% of our participants have no previous childbirths, 21.25% have 1, 49.6 have 2, 10.6 have 3 and 3.14 have 4 or more. Participants with higher parity were significantly older. No difference was observed between groups regarding Aβ status and APOE-ε4 carrier status (Table 1).

## Whole Hippocampal volume

```{r, include = F}

mod_ashs_APOE<-lmer(vol_HIPP ~  kids_total*APOE_binary*diff_mri +age_v1 + scale(vol_tiv) + education  +(1|subject), data = data_ashs[data_ashs$sex==2,])
summary(mod_ashs_APOE)
plot_model(mod_ashs_APOE, type="int")

mod_ashs_APOE2<-lmer(vol_HIPP ~  parous_group*APOE_binary*diff_mri +age_v1 +CSF_Abeta_ratio + scale(vol_tiv) + education  +(1|subject), data = data_ashs[data_ashs$sex==2,])
summary(mod_ashs_APOE2)
plot_model(mod_ashs_APOE2, type="int")
ggpredict(mod_ashs_APOE2, terms = c("APOE_binary", "diff_mri", "parous_group")) %>% plot()

trend_hippo<-emtrends(mod_ashs_APOE2, ~ APOE_binary * parous_group, var = "diff_mri", data= data_ashs)
pairs(trend_hippo, by= "parous_group")
```

We found no significant independent effect of parity on whole hippocampal volume. However, a highly significant parity, APOE-E4 and time interaction was found (β = `r tidy(mod_ashs_APOE)$estimate[12]`, SE = `r tidy(mod_ashs_APOE)$std.error[12]`, p = `r tidy(mod_ashs_APOE)$p.value[12]`), such that over time, homozygote APOE-E4 carrier women showed a negative relationship between parity and hippocampal volume, whilst non-carriers women showed the opposite.

Reproducing the analysis using our 3 parity groups showed that the direction of the interaction was present in both primiparous and multiparous groups, but only significant in the latter (β = `r tidy(mod_ashs_APOE2)$estimate[12]`, SE = `r tidy(mod_ashs_APOE2)$std.error[12]`, p = `r tidy(mod_ashs_APOE2)$p.value[12]`)(Figure X). Direct group estimate comparison using estimated marginal means also showed that the APOE4 carriership groups were only significantly different in the multiparous groups (). (Figure X)

```{r}
library(ggeffects)
effects_ashs <- ggeffect(mod_ashs_APOE, terms = c("diff_mri", "kids_total", "APOE_binary"))

# Create grid of values for prediction - specify multiple time points
time_range <- range(data_ashs$diff_mri, na.rm = TRUE)
time_seq <- seq(from = time_range[1], to = time_range[2])

emm_grid <- emmeans(mod_ashs_APOE, ~ diff_mri * kids_total * APOE_binary,
                    at = list(time = time_seq),
                    data= data_ashs)
emm_df <- as.data.frame(emm_grid)

slopes <- emtrends(mod_ashs_APOE, ~ kids_total * APOE_binary, var = "diff_mri", data= data_ashs, at = list(kids_total = c(0, 1, 2, 3, 4)))
slopes_df <- as.data.frame(slopes)

hippo_p1<-ggplot(slopes_df, aes(x = kids_total, y = diff_mri.trend, 
                            fill = as.factor(APOE_binary))) +
  geom_col(position = "dodge", alpha = 0.8, color = "black", size = 0.3) +
  geom_errorbar(aes(ymin = diff_mri.trend - SE, ymax = diff_mri.trend + SE),
                position = position_dodge(width = 0.9), width = 0.3)+
  th+
  labs(x = "Number of childbirths", 
       y = "Time slope", 
       color = "APOE4 Carriership",
       fill = "APOE4 Carriership")+
  scale_fill_manual(values = c("#1CA8B7", "#FF7043"),
                     labels = c("Non Carrier", "Carrier"))+
  geom_text(data = data.frame(parous_group = factor("Multiparous", 
                                                     levels = c("Nulliparous", "Primiparous", "Multiparous")), 
                              time_diff = Inf, 
                              Z_PACC = Inf, 
                              label = "p< 0.001"),
            aes(x = time_diff, y = Z_PACC, label = label),
            size = 4, vjust = 1, hjust = 1, inherit.aes = FALSE)
  
```

```{r, echo=F, warning=F}

preds_hip_int2 <- ggpredict(mod_ashs_APOE2, terms = c("diff_mri", "APOE_binary", "parous_group"))%>%
  as.data.frame()%>%
  filter(x %in% c(0, 6))

hippo_p2<-preds_hip_int2%>%
  mutate(group= factor(group, levels = c(0, 1), labels = c("Non-Carrier", "Carrier")),
         facet= factor(facet, levels = c("0", "1", "2+"), labels = c("Nulliparous", "Primiparous", "Multiparous")))%>%
  ggplot(aes(x= x, y=predicted, group=group, colour = group))+
  geom_line(size=1.3)+
  geom_ribbon(aes(x=x, ymin= conf.low, ymax = conf.high, group=group), alpha=0.15, colour=NA)+
  facet_wrap(~facet)+
  th+
  labs(x = "Time difference (years)", 
       y = "Whole hippocampal volume", 
       color = "APOE4 Carriership")+
  geom_text(data = data.frame(facet = factor("Multiparous", 
                                                     levels = c("Nulliparous", "Primiparous", "Multiparous")), 
                              time_diff = Inf, 
                              Z_PACC = Inf, 
                              label = "p= 0.001"),
            aes(x = time_diff, y = Z_PACC, label = label),
            size = 4, vjust = 1.5, hjust = 1.2, inherit.aes = FALSE)

```

```{r cog_hippo_all, echo=F, warning=F}

hippo_p1/hippo_p2+
  plot_annotation(tag_levels = 'A')

```

## Cognitive trajectory

```{r, include=F}
fit_cog_PACC_int<-lmer(Z_PACC ~ kids_total*APOE_binary*time_diff +age_v1 + CSF_Abeta_ratio + education +(1 | subject), data_cog_long[data_cog_long$sex==2,])
summary(fit_cog_PACC_int)
plot_model(fit_cog_PACC_int, type="int")

fit_cog_PACC_int2<-lmer(Z_PACC ~ parous_group*APOE_binary*time_diff +age_v1 + CSF_Abeta_ratio + education +(1 | subject), data_cog_long[data_cog_long$sex==2,])
summary(fit_cog_PACC_int2)
plot_model(fit_cog_PACC_int2, type="int")

```

The interaction between time, APOE4 and parity was not significant. However, the interaction between parity and APOE4 yielded a weak trend (ß = `r tidy(fit_cog_PACC_int)$estimate[8]`, SE= `r tidy(fit_cog_PACC_int)$std.error[8]`, p= `r tidy(fit_cog_PACC_int)$p.value[8]`). In comparison, using parous group as an interaction term did no yield any significant results.

No significant effect was found in men.

## Post-hoc analyses

### Hippocampal subfields

```{r, include = F}

mod_ashs_CA1<-lmer(vol_CA1 ~  kids_total*diff_mri*APOE_binary +age_v1 +CSF_Abeta_ratio + scale(vol_tiv) + education +(1|subject), data = data_ashs[data_ashs$sex==2,])
summary(mod_ashs_CA1)

mod_ashs_CA2<-lmer(vol_CA2 ~ kids_total*diff_mri*APOE_binary + age_v1 +CSF_Abeta_ratio + scale(vol_tiv) + education +(1|subject), data = data_ashs[data_ashs$sex==2,])
summary(mod_ashs_CA2)

mod_ashs_CA3<-lmer(vol_CA3 ~  kids_total*diff_mri*APOE_binary +age_v1 +CSF_Abeta_ratio + scale(vol_tiv) + education +(1|subject), data = data_ashs[data_ashs$sex==2,])
summary(mod_ashs_CA3)

mod_ashs_DG<-lmer(vol_DG ~  kids_total*diff_mri*APOE_binary +age_v1 +CSF_Abeta_ratio + scale(vol_tiv) + education +(1|subject), data = data_ashs[data_ashs$sex==2,])
summary(mod_ashs_DG)

mod_ashs_SUB<-lmer(vol_SUB ~  kids_total*diff_mri*APOE_binary +age_v1 +CSF_Abeta_ratio + scale(vol_tiv) + education +(1|subject), data = data_ashs[data_ashs$sex==2,])
summary(mod_ashs_SUB)

mod_ashs_ERC<-lmer(vol_ERC ~  kids_total*diff_mri*APOE_binary +age_v1 +CSF_Abeta_ratio + scale(vol_tiv) + education +(1|subject), data = data_ashs[data_ashs$sex==2,])
summary(mod_ashs_ERC)

mod_ashs_PHC<-lmer(vol_PHC ~  kids_total*diff_mri*APOE_binary +age_v1 +CSF_Abeta_ratio + scale(vol_tiv) + education +(1|subject), data = data_ashs[data_ashs$sex==2,])
summary(mod_ashs_PHC)

mod_ashs_BA35<-lmer(vol_BA35 ~  kids_total*diff_mri*APOE_binary +age_v1 +CSF_Abeta_ratio + scale(vol_tiv) + education +(1|subject), data = data_ashs[data_ashs$sex==2,])
summary(mod_ashs_BA35)

mod_ashs_BA36<-lmer(vol_BA36 ~  kids_total*diff_mri*APOE_binary +age_v1 +CSF_Abeta_ratio + scale(vol_tiv) + education +(1|subject), data = data_ashs[data_ashs$sex==2,])
summary(mod_ashs_BA36)

```

Similarly, no significant main effect of parity was found in any of the subfields. However, the 3-way interaction between APOE-E4 carrership, time and parity showed a significant effect on the CA1 volume (β = `r tidy(mod_ashs_CA1)$estimate[12]`, SE = `r tidy(mod_ashs_CA1)$std.error[12]`, p = `r tidy(mod_ashs_CA1)$p.value[12]`), CA2 (β = `r tidy(mod_ashs_CA2)$estimate[12]`, SE = `r tidy(mod_ashs_CA2)$std.error[12]`, p = `r tidy(mod_ashs_CA2)$p.value[12]`), subiculum (β = `r tidy(mod_ashs_SUB)$estimate[12]`, SE = `r tidy(mod_ashs_SUB)$std.error[12]`, p = `r tidy(mod_ashs_SUB)$p.value[12]`), entorhinal cortex (β = `r tidy(mod_ashs_ERC)$estimate[12]`, SE = `r tidy(mod_ashs_ERC)$std.error[12]`, p = `r tidy(mod_ashs_ERC)$p.value[12]`), and a trend in the dentate gyrus (β = `r tidy(mod_ashs_DG)$estimate[12]`, SE = `r tidy(mod_ashs_DG)$std.error[12]`, p = `r tidy(mod_ashs_DG)$p.value[12]`). The direction of the effect followed the same as for the whole hippocampus, where Aβ- women showed a positive relationship between parity and hippocampal volume over time, whilst Aβ- women showed the opposite (Figure X) - should I include the parous gorup results too? or adds too much complexity?

```{r graph subfields, echo=F, warning=F}
preds_CA1 <- ggpredict(mod_ashs_CA1, terms = c("diff_mri", "kids_total", "APOE_binary"))
preds_CA2 <- ggpredict(mod_ashs_CA2, terms = c("diff_mri", "kids_total", "APOE_binary"))
preds_SUB <- ggpredict(mod_ashs_SUB, terms = c("diff_mri", "kids_total", "APOE_binary"))
preds_ERC <- ggpredict(mod_ashs_ERC, terms = c("diff_mri", "kids_total", "APOE_binary"))
preds_DG <- ggpredict(mod_ashs_DG, terms = c("diff_mri", "kids_total", "APOE_binary"))

preds_CA1_A0<-as.data.frame(preds_CA1)%>%
  rename(kids_total_factor = group,
         APOE_binary=facet)%>%
  filter(APOE_binary==0)%>%
  mutate(APOE_binary = "Non-Carriers",,
         kids_total_factor = ifelse(kids_total_factor == 4, "4+", as.character(kids_total_factor)))


preds_CA1_A1<-as.data.frame(preds_CA1)%>%
  rename(kids_total_factor = group,
         APOE_binary=facet)%>%
  filter(APOE_binary==1)%>%
  mutate(APOE_binary = "Carriers",
         kids_total_factor = ifelse(kids_total_factor == 4, "4+", as.character(kids_total_factor)))

preds_CA2_A0<-as.data.frame(preds_CA2)%>%
  rename(kids_total_factor = group,
         APOE_binary=facet)%>%
  filter(APOE_binary==0)%>%
  mutate(APOE_binary = "Non-Carriers",,
         kids_total_factor = ifelse(kids_total_factor == 4, "4+", as.character(kids_total_factor)))


preds_CA2_A1<-as.data.frame(preds_CA2)%>%
  rename(kids_total_factor = group,
         APOE_binary=facet)%>%
  filter(APOE_binary==1)%>%
  mutate(APOE_binary = "Carriers",
         kids_total_factor = ifelse(kids_total_factor == 4, "4+", as.character(kids_total_factor)))

preds_SUB_A0<-as.data.frame(preds_SUB)%>%
  rename(kids_total_factor = group,
         APOE_binary=facet)%>%
  filter(APOE_binary==0)%>%
  mutate(APOE_binary = "Non-Carriers",,
         kids_total_factor = ifelse(kids_total_factor == 4, "4+", as.character(kids_total_factor)))


preds_SUB_A1<-as.data.frame(preds_SUB)%>%
  rename(kids_total_factor = group,
         APOE_binary=facet)%>%
  filter(APOE_binary==1)%>%
  mutate(APOE_binary = "Carriers",
         kids_total_factor = ifelse(kids_total_factor == 4, "4+", as.character(kids_total_factor)))

preds_ERC_A0<-as.data.frame(preds_ERC)%>%
  rename(kids_total_factor = group,
         APOE_binary=facet)%>%
  filter(APOE_binary==0)%>%
  mutate(APOE_binary = "Non-Carriers",,
         kids_total_factor = ifelse(kids_total_factor == 4, "4+", as.character(kids_total_factor)))


preds_ERC_A1<-as.data.frame(preds_ERC)%>%
  rename(kids_total_factor = group,
         APOE_binary=facet)%>%
  filter(APOE_binary==1)%>%
  mutate(APOE_binary = "Carriers",
         kids_total_factor = ifelse(kids_total_factor == 4, "4+", as.character(kids_total_factor)))

preds_DG_A0<-as.data.frame(preds_DG)%>%
  rename(kids_total_factor = group,
         APOE_binary=facet)%>%
  filter(APOE_binary==0)%>%
  mutate(APOE_binary = "Non-Carriers",,
         kids_total_factor = ifelse(kids_total_factor == 4, "4+", as.character(kids_total_factor)))


preds_DG_A1<-as.data.frame(preds_DG)%>%
  rename(kids_total_factor = group,
         APOE_binary=facet)%>%
  filter(APOE_binary==1)%>%
  mutate(APOE_binary = "Carriers",
         kids_total_factor = ifelse(kids_total_factor == 4, "4+", as.character(kids_total_factor)))


CA1_plot<-data_ashs %>%
  filter(sex == 2, !is.na(APOE_binary)) %>%
  mutate(kids_total_factor = ifelse(kids_total == 4, "4+", as.character(kids_total)),
         APOE_binary = factor(APOE_binary, levels = c("0", "1"), labels = c("Non-Carriers", "Carriers"))) %>%
  ggplot(aes(x = diff_mri, y = vol_CA1, color = kids_total_factor)) +
  geom_line(data =preds_CA1_A0, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_line(data =preds_CA1_A1, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_ribbon(data =preds_CA1_A0, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  geom_ribbon(data =preds_CA1_A1, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  facet_wrap(~APOE_binary) +
  scale_color_manual(values = c("0" = "#8AD9B5", "1" = "#50B88E", "2" = "#047A56", "3" = "#0A5940", "4+" = "#0F3F2D")) +
  th +
  labs(x = "Time difference (years)", 
       y = "CA1", 
       color = "Number of childbirths")+
  theme(legend.position = "none")

CA2_plot<-data_ashs %>%
  filter(sex == 2, !is.na(APOE_binary)) %>%
  mutate(kids_total_factor = ifelse(kids_total == 4, "4+", as.character(kids_total)),
         APOE_binary = factor(APOE_binary, levels = c("0", "1"), labels = c("Non-Carriers", "Carriers"))) %>%
  ggplot(aes(x = diff_mri, y = vol_CA2, color = kids_total_factor)) +
  geom_line(data =preds_CA2_A0, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_line(data =preds_CA2_A1, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_ribbon(data =preds_CA2_A0, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  geom_ribbon(data =preds_CA2_A1, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  facet_wrap(~APOE_binary) +
  scale_color_manual(values = c("0" = "#8AD9B5", "1" = "#50B88E", "2" = "#047A56", "3" = "#0A5940", "4+" = "#0F3F2D")) +
  th +
  labs(x = "Time difference (years)", 
       y = "CA2", 
       color = "Number of childbirths")+
  theme(legend.position = "none")

SUB_plot<-data_ashs %>%
  filter(sex == 2, !is.na(APOE_binary)) %>%
  mutate(kids_total_factor = ifelse(kids_total == 4, "4+", as.character(kids_total)),
         APOE_binary = factor(APOE_binary, levels = c("0", "1"), labels = c("Non-Carriers", "Carriers"))) %>%
  ggplot(aes(x = diff_mri, y = vol_SUB, color = kids_total_factor)) +
  geom_line(data =preds_SUB_A0, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_line(data =preds_SUB_A1, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_ribbon(data =preds_SUB_A0, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  geom_ribbon(data =preds_SUB_A1, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  facet_wrap(~APOE_binary) +
  scale_color_manual(values = c("0" = "#8AD9B5", "1" = "#50B88E", "2" = "#047A56", "3" = "#0A5940", "4+" = "#0F3F2D")) +
  th +
  labs(x = "Time difference (years)", 
       y = "SUB", 
       color = "Number of childbirths")+
  theme(legend.position = "none")

ERC_plot<-data_ashs %>%
  filter(sex == 2, !is.na(APOE_binary)) %>%
  mutate(kids_total_factor = ifelse(kids_total == 4, "4+", as.character(kids_total)),
         APOE_binary = factor(APOE_binary, levels = c("0", "1"), labels = c("Non-Carriers", "Carriers"))) %>%
  ggplot(aes(x = diff_mri, y = vol_ERC, color = kids_total_factor)) +
  geom_line(data =preds_ERC_A0, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_line(data =preds_ERC_A1, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_ribbon(data =preds_ERC_A0, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  geom_ribbon(data =preds_ERC_A1, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  facet_wrap(~APOE_binary) +
  scale_color_manual(values = c("0" = "#8AD9B5", "1" = "#50B88E", "2" = "#047A56", "3" = "#0A5940", "4+" = "#0F3F2D")) +
  th +
  labs(x = "Time difference (years)", 
       y = "ERC", 
       color = "Number of childbirths")+
  theme(legend.position = "none")

DG_plot<-data_ashs %>%
  filter(sex == 2, !is.na(APOE_binary)) %>%
  mutate(kids_total_factor = ifelse(kids_total == 4, "4+", as.character(kids_total)),
         APOE_binary = factor(APOE_binary, levels = c("0", "1"), labels = c("Non-Carriers", "Carriers"))) %>%
  ggplot(aes(x = diff_mri, y = vol_DG, color = kids_total_factor)) +
  geom_line(data =preds_DG_A0, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_line(data =preds_DG_A1, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_ribbon(data =preds_DG_A0, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  geom_ribbon(data =preds_DG_A1, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  facet_wrap(~APOE_binary) +
  scale_color_manual(values = c("0" = "#8AD9B5", "1" = "#50B88E", "2" = "#047A56", "3" = "#0A5940", "4+" = "#0F3F2D")) +
  th +
  labs(x = "Time difference (years)", 
       y = "DG", 
       color = "Number of childbirths")
  


(CA1_plot + CA2_plot ) / 
(ERC_plot + SUB_plot) 
```

# Discussion

Our study aimed to investigate the impact of parity on hippocampal subfield volumes and relation to the APOE4 allele in post-menopausal women at risk of AD. Our results suggest that parity and AD specific genotype interact in women to impact hippocampal volume loss. In our sample, multiparous APOE4 non-carriers showed less hippocampus volume decline, whilst multiparous APOE4 carriers showed worse cognitive decline. These rseults show evidence of an interaction between parity and AD related genetic risk in women, which is associated in volume loss in a brain region which is a prime marker of AD. Essentially, this evidence strongly suggests there is a clear biological component to the interaction between parity and AD risk in women.

When using the categorical grouping for parity, results showed significantly bigger effect in multiparous women. This could indicate that the cumulative effects of parity are only significantly interact with genetic risk after having had more than one child. However, it is important to note that the multiparous groups had a fairly larger number of observations than the nulliparous or primiparous group, therefore lack of significance might indicate a power issue when performing the gorup interaction.

The AFLFA+ cohort is an ideal cohort to test this interaction, given the participants are enriched in genetic AD risk, As such, about 40% of our cohort is a carrier of the APOE4 allele, meaning group interactions are very balanced statistically.

Our findings reproduce the ones found by Bee and colleagues. Similarly, APOE4 carriers show detrimental effects of parity on hhippocampal volume trajectory. Although we did not replicate their findings on memory, this could be due to the relative short amount of time between both visits, on 3 years in average. However, another hypothesis could be that there are intricate social factors at play in humans revolving around parity, which could be influencing cognitive resilience. A previous study done with the UK biobank also finds no effect of the interaction between APOE4 and parity on cognitive score (lindseth et al 2023), although their battery of test is limited.

Our post-hoc analysis of hippocampal subfields shows the most affected regions are the CA1, CA2, subiculum and enthorinal cortex, and a trend in the dentate gyrus. Given Bee's results, one could expect a stornger effect in the dentate gyrus, given most of the effect of parity in neurogenesis would reside in this subfield. The strong effect on parts of the cornu ammonis also reveals ageing mechanism.

Subiculum linked with early AD apthology. and ERC?

Older EPOE4 carriers show reduced hippocampal volume compared with non-carriers, especially in the CA1 and subiculum tissue @pievani2011.

A limitation of this study is the lack of a third timepoint, to examine potential non linear effects throuhg time. Some preliminary evidence suggests that during pregnancy, hippocampal reduction pattern might follow different progresison curves depending on the subfield, with the CA showing a U-curved shaped loss pattern and the para-hippocampal cortex (PHC) a linear pattern @pritschet2024.

Another limitation is statistical power. Although the ALFA+ cohort draws its strenght in the richness of the information collected form its participants, but its size remains limites for complex analyses. The stratification of analyses by gender already reduces our sample by half, and gorup interaction by APOE4 splits it further.

Another limitation is that the ALFA+ cohort is very homogeneous: participants are majoritarily caucasian whites, from middle and upper-middle class background, who were selected due to their impeccable health records. Therefore, we must use cuation when generalising our results to a wider population. Additionally, our sample lacked highly multiparous individuals. Previous studies on the effect of parity on cognition and neurodegeneration have found an inverted u-shaped relation between parity and outcome measures, indicating that our lack of women having had more than 4 children might be leading to an incomplete picture of the phenomenon.

# Appendix

## MRI data acquisition

MRI scans were acquired on a in-house 3.0 T scanner (GE Discovery MR750 W 3 T) using the same protocol for all participants, which included one T1- and three T2- weighted sequences. The 3D-T1w sequence was designed with an isotropic voxel size of1mm3 and a matrix size of256x256x160 (TR/TE/TI = 8.0/3.7/450 ms, NSA = 1, flip angle = 8°). Three 3D-T2w sequences, with a voxel size of1 mm× 1 mm× 3 mm, were also used: fluid attenuation inversion recovery (FLAIR: TR/TE/ TI = 11,000/90/2600 ms, flip angle = 160°), fast spin echo (FSE: TR/TE = 5000/85 ms, flip angle = 110°) and, gradient echo (GRE: TR/TE = 1300/23 ms, flip angle = 15°). All scans were visually assessed to verify their quality and to detect incidental findings by a trained neuroradiologist and have been reported elsewhere (Brugulat-Serrat et al. 2017). At visit 1, ten participants were excluded due to the presence of a meningioma, as well as 37 participants due to susceptibility, motion artefacts or segmentation problems, resulting in a total of 561 images available for subsequent analysis. At Visit 2, ... The medial temporal lobe atrophy was assessed by Medial Temporal Atrophy scale [@scheltens1992a].

# Miscellaneous

```{r graph whole hippocampus, eval=F}

preds_ashs <- ggpredict(mod_ashs_APOE, terms = c("diff_mri", "kids_total", "APOE_binary"))

preds_ashs_A0<-as.data.frame(preds_ashs)%>%
  rename(kids_total_factor = group,
         APOE_binary=facet)%>%
  filter(APOE_binary==0)%>%
  mutate(APOE_binary = "Non-Carrier",
         kids_total_factor= ifelse(as.character(kids_total_factor)==4, "4+", as.character(kids_total_factor)))

preds_ashs_A1<-as.data.frame(preds_ashs)%>%
  rename(kids_total_factor = group,
         APOE_binary=facet)%>%
  filter(APOE_binary==1)%>%
  mutate(APOE_binary = "Carrier",
         kids_total_factor= ifelse(as.character(kids_total_factor)==4, "4+", as.character(kids_total_factor)))

# Create a combined factor for color mapping
data_plot <- data_ashs %>%
  filter(sex == 2, !is.na(APOE_binary)) %>%
  mutate(kids_total_factor = ifelse(kids_total==4, "4+", kids_total),
         APOE_binary = factor(APOE_binary, levels = c("0", "1"), labels = c("Non-Carrier", "Carrier")),
         color_group = paste(APOE_binary, kids_total_factor, sep = "_"))

preds_ashs_A0 <- preds_ashs_A0 %>%
  mutate(color_group = paste("Non-Carrier", kids_total_factor, sep = "_"))

preds_ashs_A1 <- preds_ashs_A1 %>%
  mutate(color_group = paste("Carrier", kids_total_factor, sep = "_"))


# Define color palettes
color_values <- c(
  "Non-Carrier_0" = "#4DD0E1", "Non-Carrier_1" = "#1CA8B7", "Non-Carrier_2" = "#1E8895", "Non-Carrier_3" = "#0D707B", "Non-Carrier_4+" = "#0F565E",
  "Carrier_0" = "#FF8A65", "Carrier_1" = "#FF7043", "Carrier_2" = "#FF5722", "Carrier_3" = "#F4511E", "Carrier_4+" = "#BF360C"
)

ggplot(data_plot, aes(x = diff_mri, y = vol_HIPP, color = color_group)) +
  geom_point(alpha = 0.3, size=2) +
  geom_line(data = preds_ashs_A0, aes(x=x, y=predicted, group=kids_total_factor, color=color_group), size=1.3) +
  geom_line(data = preds_ashs_A1, aes(x=x, y=predicted, group=kids_total_factor, color=color_group), size=1.3) +
  geom_ribbon(data = preds_ashs_A0, aes(x=x, ymin=conf.low, ymax=conf.high, 
                                         group=kids_total_factor, fill=color_group), 
              inherit.aes = F, alpha=.15)+
  geom_ribbon(data = preds_ashs_A1, aes(x=x, ymin=conf.low, ymax=conf.high, 
                                         group=kids_total_factor, fill=color_group), 
              inherit.aes = F, alpha=.15)+
  facet_wrap(~APOE_binary) +
  scale_color_manual(values = color_values, labels = c("0", "1", "2", "3", "4+", "0", "1", "2", "3", "4+")) +
  scale_fill_manual(values = color_values, labels = c("0", "1", "2", "3", "4+", "0", "1", "2", "3", "4+")) +
  labs(x = "Time difference (days)", 
       y = "PACC Z-score", 
       color = "Number of childbirths",
       fill = "Number of childbirths")+
  th
```

```{r power analysis, include=F}

#power analysis if needed
sd_kids_total <- sd(data_ashs$kids_total[data_ashs$sex==2], na.rm=TRUE)
prop_A <- prop.table(table(data_ashs$APOE_binary[data_ashs$sex==2]))
p_A <- 0.488 
sd_A <- sqrt(p_A * (1 - p_A))

(34.677 * (sd_kids_total * sd_A) / sd(data_ashs$vol_HIPP[data_ashs$sex==2], na.rm=TRUE))^2

power.t.regression(beta = 34.677,
                   sd.predictor = sd_kids_total * sd_A,
                   sd.outcome = sd(data_ashs$vol_HIPP[data_ashs$sex==2], na.rm=TRUE),
                   r.squared = (34.677 * (sd_kids_total * sd_A) / sd(data_ashs$vol_HIPP[data_ashs$sex==2], na.rm=TRUE))^2,
                   null.beta = 0, 
                   k.total = 8, 
                   n=196, 
                   alpha=0.05)

```

```{r test , eval = F, include = F}
vif(mod_ashs_APOE)

mod_ashs_APOE<-lmer(vol_HIPP ~  kids_total*APOE_binary*diff_mri +age_v1 + scale(vol_tiv) + education  +(1|subject), data = data_ashs[data_ashs$sex==2 & data_ashs$A==0,])
summary(mod_ashs_APOE)


plot_model(mod_ashs_APOE, type = "int")


data_ashs_wide <- data_ashs %>%
  dplyr::select(subject, sex, age_v1, kids_total, APOE_binary, education, starts_with("vol_"), Visit, A, CSF_Abeta_ratio) %>%
  drop_na(Visit) %>%
  pivot_wider(names_from = Visit, values_from = starts_with("vol_")) %>%
  left_join(., date_mri_long)



data_ashs_wide <- data_ashs %>%
  dplyr::select(subject, sex, age_v1, kids_total, APOE_binary, education, starts_with("vol_"), Visit, A, CSF_Abeta_ratio) %>%
  drop_na(Visit) %>%
  pivot_wider(names_from = Visit, values_from = starts_with("vol_")) %>%
  left_join(., date_mri_long) %>%
  {
    df <- .
    vol_1_cols <- grep("^vol_.*_1$", names(df), value = TRUE)
    
    for (col_1 in vol_1_cols) {
      base_name <- sub("_1$", "", col_1)
      col_2 <- paste0(base_name, "_2")
      
      if (col_2 %in% names(df)) {
        df[[paste0(base_name, "_diff")]] <- (df[[col_2]] - df[[col_1]]) / df$diff_mri
      }
    }
    df
  }


test<-lm(vol_HIPP_diff ~ kids_total*APOE_binary + age_v1 + education + scale(vol_tiv_2), data = data_ashs_wide[data_ashs_wide$sex==2 & data_ashs_wide$A==0,])

summary(test)

data_ashs%>%
  filter(APOE_binary==1, A==1, sex==2)%>%
  dplyr::select(subject)%>%
  unique%>%
  nrow()

data_ashs <- data_ashs %>%
  mutate(apoeAB = case_when(
    APOE_binary == 0 & A == 0 ~ 1,
    APOE_binary == 0 & A == 1 ~ 2,
    APOE_binary == 1 & A == 0 ~ 3,
    APOE_binary == 1 & A == 1 ~ 4
  ))%>%
  mutate(apoeAB = factor(apoeAB,levels = c(1,2,3,4)))

test1<-lmer(vol_HIPP ~ kids_total*apoeAB*diff_mri + age_v1 + education + scale(vol_tiv) + (1|subject), data = data_ashs[data_ashs$sex==2,])

# Get predicted values
pred <- ggpredict(test1, terms = c("kids_total [all]", "apoeAB [1,2,3,4]", "diff_mri"))

# Plot with custom colors
ggplot(pred, aes(x = x, y = predicted, color = factor(group), linetype = factor(facet))) +
  geom_line(linewidth = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = factor(group)), 
              alpha = 0.1, color = NA) +
  scale_color_manual(values = c("#1b9e77", "#d95f02", "#7570b3", "#e7298a"),
                     labels = c("APOE4-/AB-", "APOE4-/AB+", "APOE4+/AB-", "APOE4+/AB+")) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3", "#e7298a"),
                    labels = c("APOE4-/AB-", "APOE4-/AB+", "APOE4+/AB-", "APOE4+/AB+")) +
  facet_wrap(~facet, labeller = labeller(facet = c("Low parity", "High parity"))) +
  labs(x = "Time", y = "Hippocampal Volume", 
       color = "Group", fill = "Group") +
  theme_minimal()
```
